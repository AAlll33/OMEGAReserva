<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RESERVA DE TABLAS OMEGA BINGO - Panel de Administración</title>
    <!-- Carga Tailwind CSS para un diseño moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #5b21b6; /* Morado Oscuro */
            --color-secondary: #facc15; /* Amarillo */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #3f0e8f; /* Fondo oscuro morado */
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .admin-panel {
            background-color: var(--color-primary);
            color: white;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 1rem;
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #4c1d95;
        }
        /* Estilo para el botón de Guardar Configuración */
        .btn-save-config {
            background-color: var(--color-primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(91, 33, 179, 0.4);
        }
        .btn-save-config:hover:not(:disabled) {
            background-color: #4c1d95;
        }
        .btn-save-config:disabled {
            background-color: #a78bfa; /* Morado claro cuando está deshabilitado */
            cursor: not-allowed;
        }

        /* Estilo del Header Amarillo */
        header {
            background-color: var(--color-secondary);
            color: var(--color-primary);
            font-size: 1.5rem;
            font-weight: 800;
            text-align: center;
            padding: 1rem 0;
            margin-bottom: 1rem;
            border-radius: 0.75rem;
        }
        /* Estilo para el modal de Error/Mensaje */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            text-align: center;
        }
        .text-purple-700 { color: #5b21b6; }
        .bg-yellow-100 { background-color: #fef3c7; }
        .text-yellow-800 { color: #92400e; }

        /* Estilo para el spinner de carga */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-secondary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body class="p-4">

    <header class="shadow-lg">
        RESERVA DE TABLAS OMEGA BINGO
        <div id="total-tablas-disponibles" class="text-sm font-semibold text-gray-700">Total de Tablas disponibles: Cargando...</div>
    </header>

    <!-- Error de Conexión (visible si falla) -->
    <div id="connection-error" class="hidden bg-red-500 text-white p-3 rounded-lg mb-4 text-sm font-semibold text-center">
        Error de conexión: Por favor, revisa la configuración de Firebase en el código.
    </div>
    
    <!-- Mensaje de Carga (Se oculta al conectar con Firebase) -->
    <div id="loading-indicator" class="bg-yellow-100 text-yellow-800 p-3 rounded-lg mb-4 text-sm font-semibold text-center flex items-center justify-center space-x-2">
        <div class="loader"></div>
        <span>Conectando con Firebase... Por favor, espere.</span>
    </div>

    <!-- Panel de Administración - Botones de Navegación -->
    <div class="flex justify-around mb-4">
        <button onclick="window.location.href = '#vista-jugador';" class="flex items-center space-x-2 bg-purple-700 hover:bg-purple-800 text-white font-bold py-3 px-4 rounded-xl transition duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
            <span>Vista del Jugador</span>
        </button>
        <button onclick="window.location.href = '#panel-administracion';" class="flex items-center space-x-2 bg-yellow-500 hover:bg-yellow-600 text-purple-900 font-bold py-3 px-4 rounded-xl transition duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2V7a5 5 0 00-5-5zM9 7a1 1 0 012 0v2h-2V7z" /></svg>
            <span>Panel de Administración</span>
        </button>
    </div>


    <!-- Sección Principal de Administración -->
    <section id="panel-administracion" class="admin-panel shadow-2xl">
        <h2 class="text-xl font-bold mb-3 flex items-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-.28-.84-.36-1.27-.24C10.04 3.42 9.8 3.87 9.8 4.3v4.43a2.32 2.32 0 011.16-.32h.01c.41 0 .78.14 1.05.38.27.24.42.59.42.98v1.89c0 .66-.46 1.25-1.12 1.39l-2.02.41a3.02 3.02 0 00-1.89.56l-1.01.6c-.34.2-.6.47-.73.8-.13.33-.17.69-.1.97.07.28.25.54.51.72.26.18.6.28 1 .28h6.12c.7 0 1.27-.58 1.27-1.3v-1.89c0-.4-.15-.75-.42-.98-.27-.24-.64-.38-1.05-.38h-.01a2.32 2.32 0 01-1.16-.32V4.3c0-.43-.24-.88-.67-1.01zM10 18a8 8 0 100-16 8 8 0 000 16z" clip-rule="evenodd" /></svg>
            <span>Panel de Administración</span>
        </h2>
        <div id="admin-id" class="text-sm mb-4">Admin ID: Cargando...</div>

        <!-- Bloque de Configuración General -->
        <div class="card bg-purple-100 text-purple-900">
            <h3 class="text-lg font-bold mb-3 text-purple-700">Configuración General</h3>
            
            <label class="block text-sm font-medium mb-1">Costo de la Tabla (Ej: 300,00 Bs):</label>
            <input type="number" id="costo-tabla" value="300" class="w-full p-2 border border-purple-300 rounded-lg mb-3 focus:ring-purple-500 focus:border-purple-500">

            <label class="block text-sm font-medium mb-1">WhatsApp del Administrador (Solo números, con código de país. Ej: 584121234567):</label>
            <input type="text" id="whatsapp-admin" value="58426431972" class="w-full p-2 border border-purple-300 rounded-lg mb-3 focus:ring-purple-500 focus:border-purple-500">

            <label class="block text-sm font-medium mb-1">Información de Pago y Reglas (se mostrará al jugador):</label>
            <textarea id="info-pago-reglas" rows="5" class="w-full p-2 border border-purple-300 rounded-lg mb-3 focus:ring-purple-500 focus:border-purple-500">25822059
04129546751
0108 provincial</textarea>

            <label class="block text-sm font-medium mb-1">Cantidad Total de Tablas Activas (Máx 75):</label>
            <input type="number" id="cantidad-total-tablas" value="75" min="1" max="75" class="w-full p-2 border border-purple-300 rounded-lg mb-1 focus:ring-purple-500 focus:border-purple-500">
            <p class="text-xs text-gray-500 mb-4">Establece el número máximo de tablas (desde 01) que estarán activas y visibles. El sistema base admite hasta 75 tablas.</p>
            
            <button onclick="guardarConfiguracion()" id="btn-guardar-configuracion" class="btn-save-config w-full transition duration-300" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7z" /><path fill-rule="evenodd" d="M18 8v5a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h12a2 2 0 012 2zM3.75 9A.75.75 0 003 9.75v1.5a.75.75 0 00.75.75h1.5A.75.75 0 006 11.25v-1.5A.75.75 0 005.25 9h-1.5z" clip-rule="evenodd" /></svg>
                Guardar Configuración
            </button>
        </div>

        <!-- Bloque de Gestión de Reservas (Simplified) -->
        <div class="card bg-purple-100 text-purple-900 mt-4">
            <h3 class="text-lg font-bold mb-3 text-purple-700">Gestión de Reservas (Ctrl + Clic para seleccionar múltiples)</h3>
            <p class="bg-yellow-100 text-yellow-800 p-3 rounded-lg mb-3">
                <span class="font-bold">Tablas Seleccionadas: </span><span id="tablas-seleccionadas-count">0</span><br>
                <span id="tablas-seleccionadas-lista">Ninguno</span>
            </p>
            <!-- Botones de Acción -->
            <div class="flex flex-wrap gap-2">
                <button class="flex items-center space-x-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-lg transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    Confirmar Venta (Vendido)
                </button>
                <button class="flex items-center space-x-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-lg transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 100 2h-2a1 1 0 100-2h2z" clip-rule="evenodd" /></svg>
                    Liberar Tablas (Disponible)
                </button>
                <button class="flex items-center space-x-1 bg-blue-400 hover:bg-blue-500 text-white font-semibold py-2 px-3 rounded-lg transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3h-2a3 3 0 01-3-3H6z" /></svg>
                    Copiar Info Detallada
                </button>
            </div>
            <!-- Aquí irían las tablas seleccionables (omitiéndolas por simplicidad del ejemplo) -->
        </div>
    </section>
    
    <!-- Modal para Errores/Mensajes (Sustituto de alert/confirm) -->
    <div id="app-modal" class="modal-overlay">
        <div class="modal-content">
            <h4 id="modal-title" class="text-xl font-bold mb-3 text-red-600">Error</h4>
            <p id="modal-message" class="mb-5">Mensaje de error.</p>
            <button id="modal-close" class="btn-primary">Cerrar</button>
        </div>
    </div>


    <script type="module">
        // Importaciones de Firebase SDK (versión 11.6.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug'); // <--- DESCOMENTADO para ayudar a depurar la conexión

        let db, auth;
        let userId = null;
        let isAuthReady = false;

        // --- Elementos de UI ---
        const btnGuardar = document.getElementById('btn-guardar-configuracion');
        const loadingIndicator = document.getElementById('loading-indicator');
        const connectionError = document.getElementById('connection-error');
        
        // --- Manejo del Modal de Mensajes ---
        const modal = document.getElementById('app-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        document.getElementById('modal-close').addEventListener('click', () => modal.style.display = 'none');

        function showMessage(title, message, isError = false) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalTitle.className = isError ? 'text-xl font-bold mb-3 text-red-600' : 'text-xl font-bold mb-3 text-green-600';
            modal.style.display = 'flex';
        }
        
        // --- Configuración de Firebase (variables de entorno seguras) ---
        const runtimeFirebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {}; 

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; 
        
        // --- Inicialización de Firebase y Autenticación ---
        async function initializeFirebase() {
            // Deshabilitar botón al inicio para evitar el error de "no está lista"
            btnGuardar.disabled = true;

            try {
                if (Object.keys(runtimeFirebaseConfig).length === 0) {
                     showMessage("Error Crítico", "La configuración de Firebase no está disponible. Asegúrate de estar en el entorno Canvas.", true);
                     connectionError.classList.remove('hidden');
                     return;
                }
                
                // 1. Inicializar App
                const app = initializeApp(runtimeFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. Autenticación (usando el token proporcionado o anónimo)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // 3. Listener de Estado de Autenticación
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true; // <--- Bandera de listo activada aquí
                    loadingIndicator.classList.add('hidden'); // <--- Ocultar carga
                    btnGuardar.disabled = false; // <--- Habilitar el botón de guardar

                    if (user) {
                        userId = user.uid;
                        document.getElementById('admin-id').textContent = 'Admin ID: ' + userId;
                        loadConfigAndReservations();
                    } else {
                        userId = crypto.randomUUID();
                        document.getElementById('admin-id').textContent = 'Admin ID: (Anon) ' + userId.substring(0, 8) + '...';
                        loadConfigAndReservations();
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                loadingIndicator.classList.add('hidden');
                connectionError.classList.remove('hidden');
                connectionError.textContent = `Error de conexión: ${error.message}. Verifica las Reglas de Seguridad.`;
                showMessage("Error Crítico de Firebase", "No se pudo conectar. Por favor, revisa la consola para ver el error de Firebase. Mensaje: " + error.message, true);
            }
        }

        // --- Lógica de Carga de Datos (onSnapshot) ---
        function loadConfigAndReservations() {
            // Ya no es necesario el chequeo 'if (!db || !userId || !isAuthReady) return;' aquí, 
            // ya que se llama DENTRO de onAuthStateChanged.
            
            // 1. Ruta del documento de configuración
            const configPath = `artifacts/${appId}/users/${userId}/config/main`;
            const configRef = doc(db, configPath);

            // 2. Escucha en tiempo real de la configuración
            onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Actualizar inputs con los datos de Firestore
                    document.getElementById('costo-tabla').value = data.costoTabla || 0;
                    document.getElementById('whatsapp-admin').value = data.whatsappAdmin || '';
                    document.getElementById('info-pago-reglas').value = data.infoPagoReglas || '';
                    document.getElementById('cantidad-total-tablas').value = data.cantidadTotalTablas || 75;
                    
                    document.getElementById('total-tablas-disponibles').textContent = `Total de Tablas disponibles: ${data.cantidadTotalTablas || '75'}`;

                } else {
                    console.log("No existe configuración previa. Usando valores por defecto.");
                }
            }, (error) => {
                console.error("Error al obtener la configuración (onSnapshot):", error);
                showMessage("Error de Lectura", "Error al cargar la configuración. Revisa tus Reglas de Seguridad de Firestore.", true);
            });
        }


        // --- Lógica para Guardar Configuración (setDoc) ---
        window.guardarConfiguracion = async function() {
            if (!db || !userId || !isAuthReady) {
                // Este mensaje solo debería salir si se intentó hacer trampa, pero lo mantenemos
                showMessage("Error", "La conexión a Firebase no está lista.", true);
                return;
            }

            const inputElement = document.getElementById('cantidad-total-tablas');
            const cantidadTotalTablas = parseInt(inputElement.value);

            if (isNaN(cantidadTotalTablas) || cantidadTotalTablas <= 0) {
                 showMessage("Error de Validación", "La cantidad total de tablas debe ser un número entero mayor a 0.", true);
                 return;
            }

            const configData = {
                // Usar parseFloat o String(value) dependiendo del tipo esperado
                costoTabla: String(document.getElementById('costo-tabla').value),
                whatsappAdmin: document.getElementById('whatsapp-admin').value,
                infoPagoReglas: document.getElementById('info-pago-reglas').value,
                cantidadTotalTablas: cantidadTotalTablas,
                timestamp: new Date().toISOString()
            };

            try {
                // Escritura: /artifacts/{appId}/users/{userId}/config/main
                const configPath = `artifacts/${appId}/users/${userId}/config/main`;
                
                await setDoc(doc(db, configPath), configData);
                
                showMessage("Éxito", "Configuración guardada correctamente.", false);
            } catch (error) {
                console.error("Error al guardar configuración:", error);
                showMessage("Error al Guardar", `Ocurrió un error al guardar. Revisa la consola y las Reglas de Seguridad. Mensaje: ${error.message}`, true);
            }
        }
        
        // Iniciar la aplicación al cargar la ventana
        window.onload = initializeFirebase;
        
    </script>
</body>
</html>

