<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva de Tablas - Omega Bingo</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Font Awesome para √≠conos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- LICENCIA Y DERECHOS DE AUTOR: MASSON -->
    <script>
        // Esta secci√≥n es una disuasi√≥n b√°sica contra la copia casual. 
        // El c√≥digo del lado del cliente siempre es visible y estas medidas son f√°cilmente anulables.

        /* * PROPIEDAD INTELECTUAL Y DERECHOS DE AUTOR
         * Masson¬© todos los derechos reservados.
         * Queda prohibida la reproducci√≥n total o parcial de este c√≥digo 
         * sin la autorizaci√≥n expresa de su propietario.
         */

        // Deshabilitar men√∫ contextual (clic derecho)
        // Puedes descomentar la siguiente l√≠nea si deseas desactivarlo completamente.
        // document.addEventListener('contextmenu', event => event.preventDefault());

        // Deshabilitar teclas comunes de desarrollador (F12, Ctrl/Cmd + Shift + I/J/C)
        // Puedes descomentar la siguiente funci√≥n si deseas desactivarlas.
        /*
        document.onkeydown = function(e) {
            if (e.key === 'F12' || 
                (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) ||
                (e.metaKey && e.altKey && (e.key === 'I' || e.key === 'J' || e.key === 'C'))
            ) {
                e.preventDefault();
                return false;
            }
        };
        */

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-purple': '#4B0082', // Morado intenso
                        'secondary-yellow': '#FFD700', // Dorado/Amarillo
                        'dark-bg': '#31005A', // Fondo oscuro
                        'light-card': '#FFFFFF',
                        'reserved': '#FFA500', // Naranja para RESERVADO (Pendiente de Pago)
                        'sold': '#FF0000', // Rojo para VENDIDO
                        'available': '#008000', // Verde para DISPONIBLE
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Estilos personalizados para el fondo principal */
        body {
            background-color: #31005A; /* dark-bg */
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        /* Estilo para los botones principales (Comprar/Reservar) */
        .primary-button {
            background-color: #FFD700; /* secondary-yellow */
            color: #4B0082; /* primary-purple */
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .primary-button:hover {
            background-color: #e0b800;
        }
        /* Estilo para tarjetas de informaci√≥n */
        .info-card {
            background-color: #FFFFFF;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        /* Estilo para los n√∫meros en la grilla */
        .number-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 0.25rem; /* Ajuste para dispositivos m√≥viles */
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.1s, border-color 0.1s;
            min-height: 48px; /* Asegurar √°rea de toque */
        }
        .number-cell:active {
            transform: scale(0.95);
        }
        /* Estilos de estado */
        .state-available { background-color: #d1e7dd; color: #0f5132; }
        .state-reserved { background-color: #ffe4b5; color: #856404; }
        .state-sold { background-color: #f8d7da; color: #721c24; }
        .state-admin-selected { background-color: #00BFFF; color: white; border: 2px solid #FFD700; }

        /* Estilo para el modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* M√°s oscuro para destacar la tabla */
            display: none; /* Oculto por defecto */
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        /* Estilo para la imagen de la tabla en el modal */
        #table-image {
            max-width: 90vw;
            max-height: 80vh;
            border-radius: 0.5rem;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        /* * PROPIEDAD INTELECTUAL Y DERECHOS DE AUTOR
         * Masson¬© todos los derechos reservados.
         * Queda prohibida la reproducci√≥n total o parcial de este c√≥digo 
         * sin la autorizaci√≥n expresa de su propietario.
         */

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, getDocs, runTransaction, updateDoc, deleteDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Establecer nivel de log para depuraci√≥n de Firestore
        setLogLevel('Debug');

        // Variables Globales de Firebase (PROPORCIONADAS POR EL ENTORNO)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        const STATE = {
            AVAILABLE: 'DISPONIBLE',
            RESERVED: 'RESERVADO',
            SOLD: 'VENDIDO'
        };

        const NUM_HARD_LIMIT = 75; // L√≠mite m√°ximo de tablas que se inicializan en el c√≥digo.
        let NUM_RANGE = NUM_HARD_LIMIT; // Cantidad total de tablas (configurable en Admin)
        const NUMBERS_PER_CARD = 4; // Cantidad de n√∫meros por cart√≥n (no usado aqu√≠ pero mantenido)

        // --- Configuraci√≥n y Rutas de Firestore ---
        const PUBLIC_COLLECTION_PATH = `/artifacts/${appId}/public/data/bingoTables`; // Colecci√≥n de tablas
        const CONFIG_DOC_PATH = `/artifacts/${appId}/public/data/config/bingo`; // Configuraci√≥n general

        // --- Simulaci√≥n de Directorio de Tablas ---
        // Placeholder, ya que las im√°genes reales no se pueden cargar desde el entorno de ejecuci√≥n.
        const getTableImageUrl = (numberStr) => {
            // Placeholder: Genera una imagen simple con el n√∫mero de tabla.
            return `https://placehold.co/400x300/4B0082/FFD700?text=TABLA+${numberStr}`; 
        };
        
        // Funci√≥n de inicializaci√≥n de Firebase
        const initializeFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Error: firebaseConfig est√° vac√≠o. Usando configuraci√≥n dummy.");
                    app = initializeApp({ apiKey: "dummy", authDomain: "dummy" });
                } else {
                    app = initializeApp(firebaseConfig);
                }

                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticaci√≥n usando el token de Canvas o an√≥nimamente
                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            isAuthReady = true;
                            document.getElementById('admin-id').textContent = `Admin ID: ${userId}`;
                        } else if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            const anonUser = await signInAnonymously(auth);
                            userId = anonUser.user.uid;
                            isAuthReady = true;
                        }
                        unsubscribe();
                        resolve();
                    });
                });

                // Iniciar listeners de Firestore
                if (isAuthReady) {
                    setupListeners();
                }

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                document.getElementById('status-message').textContent = `Error de conexi√≥n: ${error.message}.`;
            }
        };

        // --- Estado de la Aplicaci√≥n ---
        let numberData = {};
        let configData = { 
            price: '300,00 Bs', 
            availableCards: NUM_RANGE, // Este campo es redundante, lo calcula la funci√≥n de renderizado
            totalTables: NUM_HARD_LIMIT, // Nuevo campo configurable
            paymentInfo: 'Banco: 0108 (Provincial BBVA), C√©dula: V25822059, Tel√©fono: 04129546751. Tienes 30 minutos para pagar.',
            adminWhatsapp: '' 
        };
        let adminSelectedNumbers = new Set();

        // --- L√≥gica de la Base de Datos ---

        /**
         * Inicializa la estructura de la base de datos si es la primera vez.
         * Crea documentos para todos los n√∫meros (01 al 75) como DISPONIBLE.
         * NOTA: Esta funci√≥n DEBE ejecutarse solo una vez para crear la colecci√≥n base.
         */
        const initializeNumbers = async (numLimit) => {
            const batch = db.batch();
            for (let i = 1; i <= numLimit; i++) {
                const numStr = i.toString().padStart(2, '0');
                const numRef = doc(db, PUBLIC_COLLECTION_PATH, numStr);
                // Usamos set con merge true para no sobreescribir si ya existe, pero asegurando el estado inicial
                batch.set(numRef, {
                    number: numStr,
                    status: STATE.AVAILABLE,
                    reservedBy: null,
                    phone: null,
                    timestamp: null,
                    tableUrl: getTableImageUrl(numStr) // Guarda la URL/Ruta de la tabla
                }, { merge: true });
            }
            await batch.commit();
            console.log(`N√∫meros inicializados a DISPONIBLE hasta el ${numLimit}.`);
        };

        /**
         * Inicializa la configuraci√≥n (Precio, Info de Pago).
         */
        const initializeConfig = async () => {
            const configRef = doc(db, CONFIG_DOC_PATH);
            await setDoc(configRef, configData, { merge: true });
        };

        /**
         * Asigna 'cantidad' de n√∫meros DISPONIBLES a un jugador.
         */
        const reserveNumbers = async (name, phone, quantity) => {
            const reservedNums = [];
            const timestamp = new Date();

            await runTransaction(db, async (transaction) => {
                // 1. Encontrar n√∫meros DISPONIBLES dentro del rango activo (NUM_RANGE)
                const availableNumbers = Object.values(numberData)
                    .filter(n => n.status === STATE.AVAILABLE && parseInt(n.number) <= NUM_RANGE);
                
                if (availableNumbers.length < quantity) {
                    throw new Error(`Solo quedan ${availableNumbers.length} tablas disponibles.`);
                }

                // 2. Seleccionar los primeros 'quantity' n√∫meros disponibles
                // Nota: Los n√∫meros se seleccionan autom√°ticamente en orden ascendente
                const numbersToReserve = availableNumbers.slice(0, quantity).map(n => n.number);

                // 3. Actualizar el estado de cada n√∫mero
                for (const numStr of numbersToReserve) {
                    const numRef = doc(db, PUBLIC_COLLECTION_PATH, numStr);
                    transaction.update(numRef, {
                        status: STATE.RESERVED,
                        reservedBy: name,
                        phone: phone,
                        timestamp: timestamp.toISOString(),
                        adminNotes: ''
                    });
                    reservedNums.push(numStr);
                }
            });

            return reservedNums;
        };

        /**
         * Actualiza el estado de una lista de n√∫meros (USADO POR EL ADMIN).
         */
        const updateNumberStatus = async (numbers, newStatus) => {
            const batch = db.batch();
            for (const numStr of numbers) {
                const numRef = doc(db, PUBLIC_COLLECTION_PATH, numStr);
                if (newStatus === STATE.AVAILABLE) {
                    // Si se libera, borrar datos del cliente
                    batch.update(numRef, {
                        status: STATE.AVAILABLE,
                        reservedBy: null,
                        phone: null,
                        timestamp: null,
                        adminNotes: null
                    });
                } else if (newStatus === STATE.SOLD) {
                    // Si se confirma la venta, mantener datos del cliente
                    batch.update(numRef, {
                        status: STATE.SOLD,
                        // Mantener reservedBy y phone
                        adminNotes: `Vendido. Confirmado por Admin ID: ${userId} el ${new Date().toLocaleString()}`
                    });
                }
            }
            await batch.commit();
            adminSelectedNumbers.clear();
            renderAdminPanel();
            renderNumberList();
        };

        // --- Manejo del DOM y Renderizado ---

        /**
         * Renderiza la lista completa de n√∫meros en la vista del jugador y del administrador.
         * Incluye el nombre del cliente en el jugador.
         */
        const renderNumberList = () => {
            const numberGrid = document.getElementById('number-grid');
            const adminGrid = document.getElementById('admin-grid');
            numberGrid.innerHTML = '';
            adminGrid.innerHTML = '';
            let availableCount = 0;
            let reservedCount = 0;
            let soldCount = 0;

            // Usamos NUM_RANGE para determinar hasta d√≥nde renderizar
            const numbersToRender = Object.values(numberData)
                .filter(item => parseInt(item.number) <= NUM_RANGE)
                .sort((a, b) => parseInt(a.number) - parseInt(b.number));

            numbersToRender.forEach(item => {
                const numStr = item.number;
                const status = item.status || STATE.AVAILABLE; // Usar AVAILABLE si no hay estado
                const isSelected = adminSelectedNumbers.has(numStr);
                const clientName = item.reservedBy ? item.reservedBy.split(' ')[0] : '';
                
                // Contadores de estado
                if (status === STATE.AVAILABLE) availableCount++;
                if (status === STATE.RESERVED) reservedCount++;
                if (status === STATE.SOLD) soldCount++;

                // Celda para la vista del JUGADOR
                const playerCell = document.createElement('div');
                playerCell.className = `number-cell p-2 m-0.5 text-xs sm:text-sm shadow-md transition-all cursor-pointer ${status === STATE.AVAILABLE ? 'state-available' : status === STATE.RESERVED ? 'state-reserved' : 'state-sold'}`;
                playerCell.setAttribute('data-number', numStr);
                playerCell.onclick = () => handleViewTable(numStr, item);
                
                playerCell.innerHTML = `
                    <div class="font-bold text-lg">${numStr}</div>
                    <div class="text-xs font-semibold uppercase">${status}</div>
                    ${(status === STATE.RESERVED || status === STATE.SOLD) ? `<div class="text-xs font-normal mt-0.5 opacity-80 truncate" title="${item.reservedBy}">üë§ ${clientName}</div>` : ''}
                `;
                numberGrid.appendChild(playerCell);

                // Celda para la vista del ADMIN
                const adminCell = document.createElement('div');
                adminCell.className = `number-cell p-2 m-0.5 text-xs sm:text-sm shadow-md transition-all relative cursor-pointer ${isSelected ? 'state-admin-selected' : status === STATE.AVAILABLE ? 'state-available' : status === STATE.RESERVED ? 'state-reserved' : 'state-sold'}`;
                adminCell.setAttribute('data-number', numStr);
                adminCell.onclick = (e) => {
                    // Usar (Ctrl + Clic) o (Cmd + Clic) para selecci√≥n m√∫ltiple
                    if (e.ctrlKey || e.metaKey) { 
                        toggleAdminSelection(numStr);
                    } else {
                        handleViewTable(numStr, item);
                    }
                };

                // Informaci√≥n detallada en Admin Grid
                const timestamp = item.timestamp ? new Date(item.timestamp).toLocaleDateString('es-ES') : 'N/A';
                adminCell.innerHTML = `
                    <div class="flex flex-col items-center">
                        <span class="text-xl font-black">${numStr}</span>
                        <span class="text-xs font-normal uppercase">${status}</span>
                    </div>
                    ${(status !== STATE.AVAILABLE && item.reservedBy) ? 
                        `<div class="mt-1 text-center">
                            <span class="text-xs font-semibold block truncate" title="${item.reservedBy}">üë§ ${clientName}</span>
                            <span class="text-xs font-light block">üóìÔ∏è ${timestamp}</span>
                        </div>` : ''}
                `;
                
                // A√±adir tooltip con informaci√≥n completa para el admin
                adminCell.title = status !== STATE.AVAILABLE 
                    ? `Tabla ${numStr}\nEstado: ${status}\nCliente: ${item.reservedBy}\nTel√©fono: ${item.phone}\nFecha: ${timestamp}`
                    : `Tabla ${numStr}\nEstado: ${status}`;

                adminGrid.appendChild(adminCell);
            });

            // Actualizar contadores
            document.getElementById('available-count').textContent = availableCount.toString().padStart(2, '0');
            document.getElementById('reserved-count').textContent = reservedCount.toString().padStart(2, '0');
            document.getElementById('sold-count').textContent = soldCount.toString().padStart(2, '0');

            // Actualizar contador de tarjetas disponibles para el jugador
            document.getElementById('display-available-cards').textContent = availableCount;
        };

        /**
         * Maneja la visualizaci√≥n de la tabla al hacer clic en un n√∫mero.
         */
        const handleViewTable = (numStr, item) => {
            const status = item.status;
            const reservedBy = item.reservedBy;
            const tableUrl = getTableImageUrl(numStr);
            
            let title = `Tabla ${numStr} - ${status}`;
            let description = '';
            
            if (status === STATE.AVAILABLE) {
                description = 'Esta tabla est√° DISPONIBLE para reserva.';
            } else if (status === STATE.RESERVED) {
                description = `RESERVADA por ${reservedBy || 'un cliente'}. Pendiente de pago.`;
            } else if (status === STATE.SOLD) {
                description = `VENDIDA a ${reservedBy || 'un cliente'}. Pago confirmado.`;
            }

            document.getElementById('modal-table-title').textContent = title;
            document.getElementById('modal-table-description').textContent = description;
            
            const tableImage = document.getElementById('table-image');
            tableImage.src = tableUrl;
            tableImage.alt = `Tabla de Bingo n√∫mero ${numStr}`;
            
            // Configurar bot√≥n de descarga
            const downloadButton = document.getElementById('modal-download-button');
            downloadButton.onclick = () => downloadImage(tableUrl, `tabla_${numStr}_${status}.png`);
            
            // Mostrar modal de la tabla
            document.getElementById('table-modal').style.display = 'flex';
        };
        
        /**
         * Funci√≥n para descargar una imagen.
         */
        const downloadImage = (url, filename) => {
            // Utilizamos una funci√≥n de Fetch para manejar la descarga de URLs (incluyendo placeholders)
            fetch(url, {
                method: 'GET',
                mode: 'cors' // Usamos 'cors' para intentar obtener el blob
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    throw new Error(`No se pudo cargar la imagen para descargar (Status: ${response.status}).`);
                }
            })
            .then(blob => {
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(a.href); // Limpiar la URL del objeto
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error("Error al descargar:", error);
                // Intento de fallback si el error es de CORS (espec√≠fico para Placeholders/Canvas)
                showModal('Error de Descarga', 'No fue posible descargar la tabla. Intente guardar la imagen manualmente o aseg√∫rese de que la URL de la tabla es accesible.');
            });
        };

        /**
         * Alterna la selecci√≥n de un n√∫mero en el panel de administrador.
         */
        const toggleAdminSelection = (numStr) => {
            if (adminSelectedNumbers.has(numStr)) {
                adminSelectedNumbers.delete(numStr);
            } else {
                adminSelectedNumbers.add(numStr);
            }
            renderAdminPanel();
            renderNumberList(); // Re-renderizar para actualizar el estilo
        };

        /**
         * Renderiza el panel de administraci√≥n (actualiza el contador de selecci√≥n).
         */
        const renderAdminPanel = () => {
            const selectedCount = adminSelectedNumbers.size;
            document.getElementById('selected-count').textContent = selectedCount;

            const selectedNumsDiv = document.getElementById('admin-selected-numbers');
            selectedNumsDiv.textContent = selectedCount > 0 ? Array.from(adminSelectedNumbers).sort((a, b) => parseInt(a) - parseInt(b)).join(', ') : 'Ninguno';

            // Habilitar/deshabilitar botones de acci√≥n
            const actionButtons = document.querySelectorAll('#admin-actions button');
            actionButtons.forEach(btn => btn.disabled = selectedCount === 0);
        };


        /**
         * Renderiza la configuraci√≥n en el panel de jugador y administrador.
         */
        const renderConfig = () => {
            document.getElementById('display-price').textContent = configData.price;
            document.getElementById('display-info').innerHTML = configData.paymentInfo.replace(/\n/g, '<br>');
            document.getElementById('config-price').value = configData.price;
            document.getElementById('config-info').value = configData.paymentInfo;
            document.getElementById('config-admin-whatsapp').value = configData.adminWhatsapp || '';
            // El valor del total de tablas ahora se carga desde configData
            document.getElementById('config-cards').value = configData.totalTables || NUM_HARD_LIMIT; 
            // Actualizar el rango visible en la vista del jugador (aunque no est√° en el HTML original, lo a√±ado por si acaso)
            // document.getElementById('range-display-player').textContent = NUM_RANGE;
        };

        // --- Listeners de Firestore ---

        const setupListeners = () => {
            // Listener para la Configuraci√≥n
            onSnapshot(doc(db, CONFIG_DOC_PATH), (docSnap) => {
                if (docSnap.exists()) {
                    configData = docSnap.data();
                    // Actualizar NUM_RANGE si el valor en DB es v√°lido
                    const newRange = parseInt(configData.totalTables);
                    if (!isNaN(newRange) && newRange > 0 && newRange <= NUM_HARD_LIMIT) {
                        NUM_RANGE = newRange;
                    } else {
                        NUM_RANGE = NUM_HARD_LIMIT;
                    }

                    renderConfig();
                    // Volver a renderizar la lista si el rango activo cambia
                    renderNumberList();
                } else {
                    console.log("Documento de configuraci√≥n no encontrado. Inicializando.");
                    initializeConfig();
                }
            }, (error) => console.error("Error al escuchar Configuraci√≥n:", error));

            // Listener para los N√∫meros
            const q = collection(db, PUBLIC_COLLECTION_PATH);
            onSnapshot(q, async (snapshot) => {
                let allNumbersExist = true;
                const expectedNumbers = new Set();
                
                // Solo esperar n√∫meros hasta NUM_HARD_LIMIT para chequear la inicializaci√≥n
                for (let i = 1; i <= NUM_HARD_LIMIT; i++) {
                    expectedNumbers.add(i.toString().padStart(2, '0'));
                }
                
                numberData = {}; // Reiniciar data
                snapshot.docs.forEach(doc => {
                    numberData[doc.id] = doc.data();
                    expectedNumbers.delete(doc.id);
                });

                // Inicializar solo si faltan todos los n√∫meros (colecci√≥n vac√≠a)
                if (snapshot.empty) {
                    // Si est√° vac√≠a, inicializar la estructura completa con el l√≠mite fijo
                    console.warn(`Colecci√≥n de n√∫meros vac√≠a. Inicializando estructura.`);
                    await initializeNumbers(NUM_HARD_LIMIT);
                    return; // onSnapshot se volver√° a llamar con los datos inicializados
                }

                renderNumberList();
                document.getElementById('status-message').textContent = 'Datos de tablas actualizados en tiempo real.';
            }, (error) => console.error("Error al escuchar N√∫meros:", error));
        };

        // --- Funciones de Interacci√≥n del Jugador ---

        /**
         * Maneja el env√≠o del formulario de reserva.
         */
        const handlePlayerReserve = async (event) => {
            event.preventDefault();
            const form = event.target;
            const name = form.name.value.trim();
            const phone = form.phone.value.trim().replace(/[^0-9]/g, '');
            const quantity = parseInt(form.quantity.value, 10);
            
            // Filtrar disponibles solo hasta el NUM_RANGE activo
            const availableCount = Object.values(numberData).filter(n => n.status === STATE.AVAILABLE && parseInt(n.number) <= NUM_RANGE).length;

            if (!name || !phone || quantity <= 0 || quantity > availableCount) {
                showModal('Error', `Por favor, complete todos los campos correctamente. Cantidad m√°xima disponible: ${availableCount}`);
                return;
            }

            try {
                const reservedNumbers = await reserveNumbers(name, phone, quantity);
                if (reservedNumbers.length > 0) {
                    const numbersList = reservedNumbers.join(', ');
                    const whatsappMessage = generateWhatsappMessage(name, phone, quantity, numbersList);

                    // Redireccionar a WhatsApp
                    const adminWhatsapp = configData.adminWhatsapp;
                    const whatsappUrl = `https://wa.me/${adminWhatsapp}?text=${encodeURIComponent(whatsappMessage)}`;

                    showModal('¬°Reserva Exitosa!', `
                        <p class="text-lg font-semibold text-primary-purple mb-3">Tus n√∫meros/tablas reservadas son: <span class="text-secondary-yellow">${numbersList}</span></p>
                        <p class="mb-4">Se ha bloqueado tu reserva (PENDIENTE DE PAGO). Haz clic abajo para coordinar el pago con el administrador.</p>
                        <p class="text-sm italic">${configData.paymentInfo.replace(/\n/g, ' ')}</p>
                        <div class="mt-4 flex justify-center">
                            <a href="${whatsappUrl}" target="_blank" class="primary-button flex items-center">
                                <i class="fab fa-whatsapp mr-2"></i> Enviar Mensaje de Reserva
                            </a>
                        </div>
                    `);
                    form.reset(); // Limpiar formulario
                } else {
                    showModal('Aviso', 'No se pudieron reservar las tablas. Se agotaron justo ahora.');
                }
            } catch (error) {
                console.error("Error al procesar reserva:", error);
                showModal('Error al Reservar', `Hubo un problema: ${error.message}.`);
            }
        };

        /**
         * Genera el mensaje de WhatsApp con la informaci√≥n de la reserva.
         */
        const generateWhatsappMessage = (name, phone, quantity, numbersList) => {
            const now = new Date().toLocaleString('es-ES', { timeZone: 'America/Caracas' });
            return `¬°Hola! Quiero reservar ${quantity} tablas para el Bingo.\n\n` +
                   `üë§ *Nombre:* ${name}\n` +
                   `üì± *Tel√©fono:* ${phone}\n` +
                   `üîñ *N√∫meros Reservados:* ${numbersList}\n\n` +
                   `üí∏ *Pago:* El costo es ${configData.price} por cart√≥n/tabla.\n` +
                   `üïí *Hora de Reserva:* ${now}\n` +
                   `‚ö†Ô∏è *Importante:* Mi reserva est√° PENDIENTE DE PAGO. Por favor, conf√≠rmame los datos para transferir.`;
        };

        // --- Funciones de Interacci√≥n del Administrador ---

        /**
         * Maneja el guardado de la configuraci√≥n del administrador.
         */
        const handleSaveConfig = async () => {
            const price = document.getElementById('config-price').value.trim();
            const info = document.getElementById('config-info').value.trim();
            const adminWhatsapp = document.getElementById('config-admin-whatsapp').value.trim().replace(/[^0-9]/g, '');
            // Leer el nuevo valor de total de tablas
            const totalTablesStr = document.getElementById('config-cards').value.trim();
            const totalTables = parseInt(totalTablesStr, 10);


            if (!price || !info || adminWhatsapp.length < 7) {
                showModal('Error', 'Debe completar Precio, Informaci√≥n de Pago y Tel√©fono de WhatsApp del Admin.');
                return;
            }
            
            // Validaci√≥n del nuevo total de tablas
            if (isNaN(totalTables) || totalTables < 1 || totalTables > NUM_HARD_LIMIT) {
                 showModal('Error', `La Cantidad Total de Tablas debe ser un n√∫mero entre 1 y ${NUM_HARD_LIMIT}.`);
                 return;
            }


            try {
                const configRef = doc(db, CONFIG_DOC_PATH);
                await setDoc(configRef, { 
                    price: price, 
                    paymentInfo: info, 
                    adminWhatsapp: adminWhatsapp,
                    totalTables: totalTables // Guardar el nuevo valor
                }, { merge: true });
                showModal('√âxito', `Configuraci√≥n guardada correctamente. El n√∫mero de tablas activas es ahora ${totalTables}.`);
            } catch (error) {
                console.error("Error al guardar configuraci√≥n:", error);
                showModal('Error', `Error al guardar configuraci√≥n: ${error.message}`);
            }
        };

        /**
         * Confirma el pago de los n√∫meros seleccionados (los marca como VENDIDO).
         */
        const handleConfirmSale = async () => {
            if (adminSelectedNumbers.size === 0) return;
            const numbers = Array.from(adminSelectedNumbers);
            try {
                await updateNumberStatus(numbers, STATE.SOLD);
                showModal('Venta Confirmada', `Las tablas ${numbers.join(', ')} se han marcado como VENDIDO.`);
            } catch (error) {
                console.error("Error al confirmar venta:", error);
                showModal('Error', `No se pudo confirmar la venta: ${error.message}`);
            }
        };

        /**
         * Libera los n√∫meros seleccionados (los marca como DISPONIBLE).
         */
        const handleLiberateNumbers = async () => {
            if (adminSelectedNumbers.size === 0) return;
            const numbers = Array.from(adminSelectedNumbers);

            // Filtra solo los n√∫meros que est√°n RESERVADO o VENDIDO para liberar
            const validNumbers = numbers.filter(num => numberData[num]?.status !== STATE.AVAILABLE);

            if (validNumbers.length === 0) {
                 showModal('Aviso', 'Solo se pueden liberar tablas RESERVADAS o VENDIDAS.');
                 return;
            }

            try {
                await updateNumberStatus(validNumbers, STATE.AVAILABLE);
                showModal('Tablas Liberadas', `Las tablas ${validNumbers.join(', ')} se han liberado y est√°n de nuevo DISPONIBLES.`);
            } catch (error) {
                console.error("Error al liberar n√∫meros:", error);
                showModal('Error', `No se pudo liberar las tablas: ${error.message}`);
            }
        };

        /**
         * Copia la lista de n√∫meros seleccionados en formato WhatsApp para el admin.
         */
        const copyAdminList = () => {
            const selectedNums = Array.from(adminSelectedNumbers).sort((a, b) => parseInt(a) - parseInt(b));
            if (selectedNums.length === 0) {
                showModal('Aviso', 'Seleccione al menos un n√∫mero para copiar.');
                return;
            }

            const details = selectedNums.map(num => {
                const data = numberData[num];
                const status = data.status;
                const reservedBy = data.reservedBy || 'N/A';
                const phone = data.phone || 'N/A';
                const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleString('es-ES') : 'N/A';
                return `*Tabla:* ${num} | *Estado:* ${status} | *Cliente:* ${reservedBy} | *Tel√©fono:* ${phone} | *Reserva:* ${timestamp}`;
            }).join('\n');

            const textToCopy = `üìã *Reporte de Tablas Seleccionadas (${selectedNums.length}):*\n\n${details}`;

            // Copiar al portapapeles
            const tempInput = document.createElement("textarea");
            tempInput.value = textToCopy;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            showModal('Copiado', `Se ha copiado la informaci√≥n detallada de ${selectedNums.length} tablas al portapapeles.`);
        }


        // --- Funciones Utilitarias (Modal) ---

        /**
         * Muestra el modal de mensaje personalizado.
         */
        const showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = message;
            document.getElementById('custom-modal').style.display = 'flex';
        };

        /**
         * Cierra el modal de mensaje.
         */
        const closeModal = () => {
            document.getElementById('custom-modal').style.display = 'none';
        };
        
        /**
         * Cierra el modal de la tabla.
         */
        const closeTableModal = () => {
            document.getElementById('table-modal').style.display = 'none';
        }


        // --- Inicializaci√≥n de Eventos ---

        window.onload = () => {
            initializeFirebase();
            document.getElementById('reservation-form').addEventListener('submit', handlePlayerReserve);
            document.getElementById('admin-save-config').addEventListener('click', handleSaveConfig);
            document.getElementById('admin-confirm-sale').addEventListener('click', handleConfirmSale);
            document.getElementById('admin-liberate-numbers').addEventListener('click', handleLiberateNumbers);
            document.getElementById('admin-copy-list').addEventListener('click', copyAdminList);
            document.getElementById('modal-close-button').addEventListener('click', closeModal);
            document.getElementById('modal-overlay-close').addEventListener('click', closeModal);
            document.getElementById('table-modal-close-button').addEventListener('click', closeTableModal);
            document.getElementById('table-modal-overlay-close').addEventListener('click', closeTableModal);
        };

        window.closeModal = closeModal;
        window.closeTableModal = closeTableModal;
        window.handleViewTable = handleViewTable; // Exponer para la grilla
    </script>
</head>

<body class="p-4 sm:p-8">
    
    <!-- Modal de Mensaje General -->
    <div id="custom-modal" class="modal-overlay z-[60]">
        <div id="modal-overlay-close" class="absolute w-full h-full"></div>
        <div class="info-card max-w-lg w-full z-10 p-6">
            <h2 id="modal-title" class="text-2xl font-bold text-primary-purple mb-4">T√≠tulo</h2>
            <div id="modal-body" class="mb-6 text-gray-700">Contenido del mensaje.</div>
            <div class="flex justify-end">
                <button id="modal-close-button" class="bg-primary-purple text-white py-2 px-4 rounded-lg font-semibold hover:bg-opacity-80 transition">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Visualizaci√≥n de Tabla -->
    <div id="table-modal" class="modal-overlay z-[70]">
        <div id="table-modal-overlay-close" class="absolute w-full h-full"></div>
        <div class="max-w-4xl w-full z-10 p-4 bg-white rounded-xl shadow-2xl relative">
            <button onclick="closeTableModal()" class="absolute top-3 right-3 text-primary-purple text-3xl font-bold p-2 leading-none hover:text-red-500 transition">
                &times;
            </button>
            
            <div class="text-center mb-4">
                <h2 id="modal-table-title" class="text-2xl font-black text-primary-purple">Tabla ## - DISPONIBLE</h2>
                <p id="modal-table-description" class="text-gray-600 text-sm italic">Descripci√≥n del estado y cliente.</p>
            </div>

            <div class="flex justify-center mb-4">
                <img id="table-image" src="" alt="Imagen de la Tabla de Bingo" class="border-4 border-secondary-yellow">
            </div>

            <div class="flex justify-center">
                <button id="modal-download-button" class="bg-primary-purple text-white py-2 px-4 rounded-lg font-semibold hover:bg-opacity-80 transition flex items-center">
                    <i class="fas fa-download mr-2"></i> Descargar Tabla
                </button>
            </div>
        </div>
    </div>

    <!-- Contenedor principal de la aplicaci√≥n -->
    <main class="max-w-4xl mx-auto">
        <!-- T√≠tulo principal -->
        <header class="text-center mb-6 p-4 rounded-xl bg-secondary-yellow text-primary-purple shadow-xl">
            <h1 class="text-3xl sm:text-4xl font-black uppercase">
                <i class="fas fa-table mr-2"></i> Reserva de Tablas OMEGA Bingo
            </h1>
            <p class="text-sm font-semibold mt-1">Total de Tablas disponibles: <span id="display-available-cards" class="font-black text-xl">--</span></p>
        </header>

        <!-- Mensaje de estado (Conexi√≥n) -->
        <p id="status-message" class="text-center text-secondary-yellow text-sm mb-4">Cargando datos en tiempo real...</p>

        <!-- Selector de Vistas -->
        <div class="flex justify-center mb-6 space-x-4">
            <button onclick="document.getElementById('player-view').style.display='block'; document.getElementById('admin-view').style.display='none';" class="py-2 px-4 rounded-lg font-semibold bg-primary-purple text-white hover:opacity-80 transition">
                <i class="fas fa-user-friends"></i> Vista del Jugador
            </button>
            <button onclick="document.getElementById('player-view').style.display='none'; document.getElementById('admin-view').style.display='block';" class="py-2 px-4 rounded-lg font-semibold bg-secondary-yellow text-primary-purple hover:opacity-80 transition">
                <i class="fas fa-user-shield"></i> Panel de Administraci√≥n
            </button>
        </div>

        <!-- VISTA DEL JUGADOR (RESERVA) -->
        <section id="player-view" class="space-y-6">

            <!-- Informaci√≥n de Pago y Precio -->
            <div class="info-card">
                <h2 class="text-2xl font-bold text-primary-purple mb-4 flex items-center">
                    <i class="fas fa-money-bill-wave mr-2"></i> Costo y Pago
                </h2>
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-3 mb-3">
                    <p class="text-lg font-semibold text-gray-600">Costo de la Tabla:</p>
                    <p id="display-price" class="text-2xl font-black text-secondary-yellow bg-primary-purple px-3 py-1 rounded-lg">Cargando...</p>
                </div>
                <div>
                    <h3 class="font-semibold text-primary-purple mb-2">Datos para Reserva y Pago:</h3>
                    <pre id="display-info" class="bg-gray-100 p-3 rounded-lg text-sm whitespace-pre-wrap">Cargando informaci√≥n...</pre>
                </div>
            </div>

            <!-- Formulario de Reserva -->
            <div class="info-card">
                <h2 class="text-2xl font-bold text-primary-purple mb-4 flex items-center">
                    <i class="fas fa-edit mr-2"></i> Formulario de Reserva
                </h2>
                <form id="reservation-form" class="space-y-4">
                    <input type="text" name="name" placeholder="Nombre Completo del Jugador" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-purple focus:border-primary-purple transition">
                    <input type="tel" name="phone" placeholder="N√∫mero de Tel√©fono / WhatsApp (Ej: 04121234567)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-purple focus:border-primary-purple transition">
                    <input type="number" name="quantity" min="1" max="75" placeholder="Cantidad de Tablas a Reservar (M√°x 75)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-purple focus:border-primary-purple transition">

                    <button type="submit" class="w-full primary-button uppercase">
                        <i class="fas fa-lock mr-2"></i> Reservar y Coordinar Pago
                    </button>
                </form>
            </div>

            <!-- Grilla de N√∫meros Disponibles -->
            <div class="info-card">
                <h2 class="text-2xl font-bold text-primary-purple mb-4 flex items-center">
                    <i class="fas fa-list-ol mr-2"></i> Estado de Tablas (01 - <span id="range-display-player">{{NUM_RANGE}}</span>). Toca para ver la tabla.
                </h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 mb-4 p-3 rounded-lg border">
                    <div class="flex items-center text-sm font-semibold text-available"><span class="w-3 h-3 rounded-full bg-available mr-2"></span>DISPONIBLE (<span id="available-count">00</span>)</div>
                    <div class="flex items-center text-sm font-semibold text-reserved"><span class="w-3 h-3 rounded-full bg-reserved mr-2"></span>RESERVADO (<span id="reserved-count">00</span>)</div>
                    <div class="flex items-center text-sm font-semibold text-sold"><span class="w-3 h-3 rounded-full bg-sold mr-2"></span>VENDIDO (<span id="sold-count">00</span>)</div>
                </div>

                <div id="number-grid" class="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-1 text-center border p-2 rounded-lg bg-gray-50 max-h-96 overflow-y-auto">
                    <!-- Las tablas se renderizan aqu√≠ -->
                </div>
            </div>
        </section>


        <!-- VISTA DE ADMINISTRACI√ìN -->
        <section id="admin-view" class="space-y-6 hidden">
            <div class="info-card bg-primary-purple text-white">
                <h2 class="text-2xl font-bold mb-2 flex items-center">
                    <i class="fas fa-cogs mr-2"></i> Panel de Administraci√≥n
                </h2>
                <p id="admin-id" class="text-sm italic opacity-75">Admin ID: Cargando...</p>
            </div>

            <!-- Configuraci√≥n General -->
            <div class="info-card">
                <h3 class="text-xl font-bold text-primary-purple mb-4">Configuraci√≥n General</h3>
                <div class="space-y-4">
                    <label class="block">
                        <span class="text-gray-700 font-semibold">Costo de la Tabla (Ej: 300,00 Bs):</span>
                        <input type="text" id="config-price" class="w-full p-3 border border-gray-300 rounded-lg mt-1" value="">
                    </label>
                    <label class="block">
                        <span class="text-gray-700 font-semibold">WhatsApp del Administrador (Solo n√∫meros, con c√≥digo de pa√≠s. Ej: 584121234567):</span>
                        <input type="tel" id="config-admin-whatsapp" class="w-full p-3 border border-gray-300 rounded-lg mt-1" placeholder="Ej: 584121234567" value="">
                    </label>
                    <label class="block">
                        <span class="text-gray-700 font-semibold">Informaci√≥n de Pago y Reglas (se mostrar√° al jugador):</span>
                        <textarea id="config-info" rows="5" class="w-full p-3 border border-gray-300 rounded-lg mt-1 resize-none"></textarea>
                    </label>
                    <!-- CAMBIO: Campo de Cantidad de Tablas ahora es editable -->
                    <label class="block">
                        <span class="text-gray-700 font-semibold">Cantidad Total de Tablas Activas (M√°x 75):</span>
                        <input type="number" id="config-cards" 
                               min="1" 
                               max="75"
                               placeholder="1 a 75"
                               class="w-full p-3 border border-gray-300 rounded-lg mt-1 transition">
                        <p class="text-xs mt-1 text-gray-500">
                            Establece el n√∫mero m√°ximo de tablas (desde 01) que estar√°n activas y visibles. El sistema base admite hasta 75 tablas.
                        </p>
                    </label>
                    <!-- FIN DEL CAMBIO -->
                    <button id="admin-save-config" class="w-full bg-primary-purple text-white py-3 rounded-lg font-semibold hover:bg-opacity-80 transition">
                        <i class="fas fa-save mr-2"></i> Guardar Configuraci√≥n
                    </button>
                </div>
            </div>

            <!-- Grilla y Acciones de Gesti√≥n -->
            <div class="info-card">
                <h3 class="text-xl font-bold text-primary-purple mb-4">Gesti√≥n de Reservas (Ctrl + Clic para seleccionar m√∫ltiples)</h3>

                <!-- Estado de Selecci√≥n -->
                <div class="mb-4 p-3 border border-secondary-yellow bg-yellow-50 rounded-lg">
                    <p class="font-semibold text-lg text-primary-purple">Tablas Seleccionadas: <span id="selected-count" class="text-2xl font-black">0</span></p>
                    <p id="admin-selected-numbers" class="text-sm italic text-gray-600 truncate">Ninguno</p>
                </div>

                <!-- Botones de Acci√≥n -->
                <div id="admin-actions" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6">
                    <button id="admin-confirm-sale" disabled class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition disabled:opacity-50 text-sm">
                        <i class="fas fa-check-circle mr-1"></i> Confirmar Venta (Vendido)
                    </button>
                    <button id="admin-liberate-numbers" disabled class="w-full bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition disabled:opacity-50 text-sm">
                        <i class="fas fa-trash-alt mr-1"></i> Liberar Tablas (Disponible)
                    </button>
                    <button id="admin-copy-list" disabled class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition disabled:opacity-50 text-sm">
                        <i class="fas fa-copy mr-1"></i> Copiar Info Detallada
                    </button>
                </div>

                <!-- Grilla de Administraci√≥n -->
                <div id="admin-grid" class="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-1 text-center border p-2 rounded-lg bg-gray-50 max-h-[500px] overflow-y-auto">
                    <!-- Las tablas se renderizan aqu√≠. Toca para ver la tabla, Ctrl+Clic para seleccionar. -->
                </div>
            </div>
        </section>
    </main>

    <footer class="text-center text-xs text-gray-400 mt-8 mb-4">
        &copy; 2025 Sistema de Reservas. Desarrollado con Firebase y Tailwind.<br>
        <span class="text-secondary-yellow font-bold">Masson¬© todos los derechos reservados.</span>
    </footer>
</body>
</html>

